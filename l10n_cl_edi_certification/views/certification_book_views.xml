<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Vista Form: Libro de Compra/Venta -->
        <record id="view_certification_book_form" model="ir.ui.view">
            <field name="name">certification.book.form</field>
            <field name="model">l10n_cl_edi.certification.book</field>
            <field name="arch" type="xml">
                <form string="Libro de Compra/Venta">
                    <header>
                        <button name="action_generate_book" string="Generar XML del Libro" type="object"
                                invisible="state != 'draft'" class="oe_highlight"/>
                        <button name="action_sign_book" string="Firmar Libro" type="object"
                                invisible="state != 'generated'" class="oe_highlight"/>
                        <button name="action_send_to_sii" string="Enviar al SII" type="object"
                                invisible="state != 'signed'" class="oe_highlight"/>
                        <button name="action_back_to_draft" string="Regresar a Borrador" type="object"
                                invisible="state == 'draft'"/>
                        <field name="state" widget="statusbar"
                               statusbar_visible="draft,generated,signed,sent,accepted"/>
                    </header>
                    <sheet>
                        <widget name="web_ribbon" title="Aceptado" bg_color="text-bg-success" invisible="state != 'accepted'"/>
                        <widget name="web_ribbon" title="Rechazado" bg_color="text-bg-danger" invisible="state != 'rejected'"/>
                        <div class="oe_title">
                            <label for="name" string="Nombre del Libro"/>
                            <h1>
                                <field name="name" placeholder="ej. Libro de Ventas 4609306"/>
                            </h1>
                        </div>
                        <group>
                            <group string="Información General">
                                <field name="project_id" readonly="1"/>
                                <field name="book_type" widget="badge"/>
                                <field name="attention_number"/>
                                <field name="period"/>
                            </group>
                            <group string="Envío al SII">
                                <field name="sii_track_id" readonly="1"/>
                                <field name="sii_send_date" readonly="1"/>
                                <field name="sii_response_id" readonly="1"/>
                            </group>
                        </group>
                        <group string="Archivos XML">
                            <group>
                                <field name="book_xml" filename="book_xml_filename" widget="binary"/>
                                <field name="book_xml_filename" invisible="1"/>
                            </group>
                            <group>
                                <field name="book_xml_signed" filename="book_xml_signed_filename" widget="binary"/>
                                <field name="book_xml_signed_filename" invisible="1"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Líneas de Detalle" name="lines">
                                <field name="line_ids">
                                    <list editable="bottom" create="1" delete="1">
                                        <field name="sequence" widget="handle"/>
                                        <field name="document_type_code"/>
                                        <field name="folio"/>
                                        <field name="issue_date"/>
                                        <field name="partner_rut"/>
                                        <field name="partner_name"/>
                                        <field name="mnt_exento" sum="Total Exento" widget="monetary" optional="hide"/>
                                        <field name="mnt_neto" sum="Total Neto" widget="monetary"/>
                                        <field name="mnt_iva" sum="Total IVA" widget="monetary"/>
                                        <field name="iva_uso_comun" sum="IVA Uso Común" widget="monetary" optional="show"/>
                                        <field name="factor_proporcionalidad" optional="show"/>
                                        <field name="credito_iva_uso_comun" sum="Crédito IVA" widget="monetary" optional="show"/>
                                        <field name="mnt_total" sum="Total" widget="monetary"/>
                                        <field name="currency_id" column_invisible="1"/>
                                    </list>
                                </field>
                            </page>
                            <page string="Notas" name="notes">
                                <field name="notes" placeholder="Notas internas para referencia..."/>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter/>
                </form>
            </field>
        </record>

        <!-- Vista Tree: Libro de Compra/Venta -->
        <record id="view_certification_book_tree" model="ir.ui.view">
            <field name="name">certification.book.tree</field>
            <field name="model">l10n_cl_edi.certification.book</field>
            <field name="arch" type="xml">
                <list string="Libros de Compra/Venta"
                      decoration-muted="state == 'draft'"
                      decoration-info="state == 'generated'"
                      decoration-warning="state in ['signed', 'sent']"
                      decoration-success="state == 'accepted'"
                      decoration-danger="state == 'rejected'">
                    <field name="name"/>
                    <field name="project_id"/>
                    <field name="book_type" widget="badge"/>
                    <field name="attention_number"/>
                    <field name="period"/>
                    <field name="sii_track_id"/>
                    <field name="state" widget="badge"
                           decoration-muted="state == 'draft'"
                           decoration-info="state == 'generated'"
                           decoration-warning="state in ['signed', 'sent']"
                           decoration-success="state == 'accepted'"
                           decoration-danger="state == 'rejected'"/>
                </list>
            </field>
        </record>

        <!-- Vista Search -->
        <record id="view_certification_book_search" model="ir.ui.view">
            <field name="name">certification.book.search</field>
            <field name="model">l10n_cl_edi.certification.book</field>
            <field name="arch" type="xml">
                <search string="Buscar Libros">
                    <field name="name"/>
                    <field name="project_id"/>
                    <field name="attention_number"/>
                    <field name="period"/>
                    <field name="sii_track_id"/>
                    <separator/>
                    <filter string="Borrador" name="draft" domain="[('state', '=', 'draft')]"/>
                    <filter string="Generado" name="generated" domain="[('state', '=', 'generated')]"/>
                    <filter string="Firmado" name="signed" domain="[('state', '=', 'signed')]"/>
                    <filter string="Enviado" name="sent" domain="[('state', '=', 'sent')]"/>
                    <filter string="Aceptado" name="accepted" domain="[('state', '=', 'accepted')]"/>
                    <filter string="Rechazado" name="rejected" domain="[('state', '=', 'rejected')]"/>
                    <separator/>
                    <filter string="Libro de Ventas" name="sales" domain="[('book_type', '=', 'sale')]"/>
                    <filter string="Libro de Compras" name="purchases" domain="[('book_type', '=', 'purchase')]"/>
                    <group expand="0" string="Agrupar por">
                        <filter string="Proyecto" name="group_project" context="{'group_by': 'project_id'}"/>
                        <filter string="Tipo" name="group_type" context="{'group_by': 'book_type'}"/>
                        <filter string="Estado" name="group_state" context="{'group_by': 'state'}"/>
                        <filter string="Período" name="group_period" context="{'group_by': 'period'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Action -->
        <record id="action_certification_book" model="ir.actions.act_window">
            <field name="name">Libros de Compra/Venta</field>
            <field name="res_model">l10n_cl_edi.certification.book</field>
            <field name="view_mode">list,form</field>
            <field name="context">{}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Crear un nuevo Libro de Compra/Venta
                </p>
                <p>
                    Los libros electrónicos de compra y venta son parte del proceso de certificación ante el SII.
                    El Libro de Ventas se genera automáticamente desde los documentos del SET BÁSICO,
                    mientras que el Libro de Compras se importa desde el set de pruebas.
                </p>
            </field>
        </record>

    </data>
</odoo>
